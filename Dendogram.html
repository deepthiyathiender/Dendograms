<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <style>

        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 10px;
            stroke-opacity: 0.5;
        }

        .tree_headers {
            padding-left: 30px;
        }

        .fancy_button {
            color: #000;
            display: inline-block;
            margin: 10px;
            background: rgba(113, 196, 216, 0.5);
            -webkit-border-radius: 10px;
            border-radius: 10px;
            text-decoration: none;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .fancy_button:hover {
            background: rgba(198, 163, 205, 0.8);

        }

        .widget {
            margin: 0 auto;
            width: 400px;
            margin-top: 50px;
            border-radius: 5px;
            box-shadow: 0px 0px 1px 0px #ffffff;
            position: fixed;
            top: 100px;
        }

        .header {
            background-color: #ffffff;
            height: 40px;
            color: #000000;
            text-align: center;
            line-height: 20px;
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
            font-weight: 200;
            font-size: 1.5em;
            text-shadow: 1px 1px #ffffff;
            margin-bottom: 50px;
            margin-left: 150px;
            font-size: 15px;
        }

        .chart-container {
            padding: 25px;
        }

        .shadow {
            -webkit-filter: drop-shadow(0px 3px 3px rgba(255, 255, 255, 0.5));
            filter: drop-shadow(0px 3px 3px rgba(255, 255, 255, 0.5));
        }

        #pie {
            background-color: white;
        }


        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .bar {
            fill: orange;
        }

        .bar:hover {
            fill: orangered;
        }

        .x.axis path {
            display: none;
        }

        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 2px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }

        /* Style northward tooltips differently */
        .d3-tip.n:after {
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
        }

    </style>

</head>

<body>

<table style="padding-left: 430px">
    <tr>
        <td class="tree_headers">
            <h3>Counterparty</h3>
        </td>
        <td class="tree_headers">
            <h3>Instruments</h3>
        </td>
        <td class="tree_headers">
            <input type="button" class="fancy_button" value="Expand All" onclick="expandAll()"/>
        </td>
        <td>
            <input type="button" class="fancy_button" value="Collapse All" onclick="collapseAll()"/>
        </td>
    </tr>
</table>

<table>
    <tr>
        <td id="tree">
        </td>
        <td style="vertical-align:top; padding-top: 300px">
            <div class="widget">
                <div id="header" class="header"></div>
                <div id="pie" class="chart-container">

                </div>
            </div>
        </td>
    </tr>
</table>

<!-- load the d3.js library -->
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/d3.tip.v0.6.3.js"></script>


<script>

    var BondMap = {};
    var EquititesMap = {};
    var FxOTCMap = {};
    var FxSwapMap = {};
    var IRSDealMap = {};
    var LDDealMap = {};
    var map = {};

    function loadCSVs() {
        queue()
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_Bond.csv", function (data) {
                    if (!(data["Counterparty"] in BondMap)) {
                        BondMap[data["Counterparty"]] = {
                            value: parseInt(data["Market Value (USD)"].replace(/,/g, ""))
                        };
                    }
                    else {

                        var existingValue = BondMap[data["Counterparty"]].value;
                        BondMap[data["Counterparty"]].value = parseInt(data["Market Value (USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_Equities.csv", function (data) {
                    if (!(data["Cpty"] in EquititesMap)) {
                        EquititesMap[data["Cpty"]] = {
                            value: parseInt(data["Market Value(USD)"].replace(/,/g, ""))
                        };
                    }
                    else {
                        var existingValue = EquititesMap[data["Cpty"]].value;
                        EquititesMap[data["Cpty"]].value = parseInt(data["Market Value(USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_FxOTC.csv", function (data) {
                    if (!(data["Counterparty"] in FxOTCMap)) {
                        FxOTCMap[data["Counterparty"]] = {
                            value: parseInt(data["Market Value (USD)"].replace(/,/g, ""))
                        };
                    }
                    else {
                        var existingValue = FxOTCMap[data["Counterparty"]].value;
                        FxOTCMap[data["Counterparty"]].value = parseInt(data["Market Value (USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_FxSwap.csv", function (data) {
                    if (!(data["Counterparty"] in FxSwapMap)) {
                        FxSwapMap[data["Counterparty"]] = {
                            value: parseInt(data["Market Value(USD)"].replace(/,/g, ""))
                        };
                    }
                    else {
                        var existingValue = FxSwapMap[data["Counterparty"]].value;
                        FxSwapMap[data["Counterparty"]].value = parseInt(data["Market Value(USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_IRSDeal.csv", function (data) {
                    if (!(data["Counterparty Paying"] in IRSDealMap)) {
                        IRSDealMap[data["Counterparty Paying"]] = {
                            value: parseInt(data["Market Value (USD)"].replace(/,/g, ""))
                        };
                    }
                    else {
                        var existingValue = IRSDealMap[data["Counterparty Paying"]].value;
                        IRSDealMap[data["Counterparty Paying"]].value = parseInt(data["Market Value (USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/mega_table_L&DDeal.csv", function (data) {
                    if (!(data["Counterparty"] in LDDealMap)) {
                        LDDealMap[data["Counterparty"]] = {
                            value: parseInt(data["Market Value (USD)"].replace(/,/g, ""))
                        };
                    }
                    else {
                        var existingValue = LDDealMap[data["Counterparty"]].value;
                        LDDealMap[data["Counterparty"]].value = parseInt(data["Market Value (USD)"].replace(/,/g, "")) + existingValue;
                    }
                })
                .defer(d3.csv, "https://raw.githubusercontent.com/deepthiyathiender/Dendograms/master/creditLimit.csv", function (data) {
                    if (!(data["Coverage-Counterparty"] in map)) {
                        map[data["Coverage-Counterparty"]] = {
                            name: data["Coverage-Counterparty"],
                            rating: data.Rating,
                            alloc: data.Allocation,
                            "product-exp": []
                        };

                        map[data["Coverage-Counterparty"]]["product-exp"].push(data["Product Exposure"]);
                    }
                    else {
                        map[data["Coverage-Counterparty"]]["product-exp"].push(data["Product Exposure"]);
                    }
                })
                .await(function () {
                })
    }
</script>

<script>
    function drawPie(dataset) {

        var pie = d3.layout.pie()
                .value(function (d) {
                    return d.percent
                })
                .sort(null)
                .padAngle(.03);

        var w = 300, h = 300;

        var outerRadius = w / 2;
        var innerRadius = 100;

        //var color = d3.scale.category10();
        color = d3.scale.ordinal()
                .domain(0, 1)
                .range(["#cc0000", "#009900"]);

        var arc = d3.svg.arc()
                .outerRadius(outerRadius)
                .innerRadius(innerRadius);

        var svg = d3.select("#pie")
                .append("svg")
                .attr({
                    width: 500,
                    height: 400,
                    class: 'shadow'
                }).append('g')
                .attr({
                    transform: 'translate(' + 500 / 2 + ',' + 400 / 2 + ')'
                });
        var path = svg.selectAll('path')
                .data(pie(dataset))
                .enter()
                .append('path')
                .attr({
                    d: arc,
                    fill: function (d, i) {
                        return color(d.data.name);
                    }
                });

        path.transition()
                .duration(1000)
                .attrTween('d', function (d) {
                    var interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
                    return function (t) {
                        return arc(interpolate(t));
                    };
                });


        var restOfTheData = function () {
            var text = svg.selectAll('text')
                    .data(pie(dataset))
                    .enter()
                    .append("text")
                    .transition()
                    .duration(200)
                    .attr("transform", function (d) {
                        debugger;

                        var c = arc.centroid(d);
                        return "translate(" + c[0] * 1.47 + "," + c[1] * 1.47 + ")";
                        //return "translate(" + arc.centroid(d) + ")";
                    })
                    .attr("dy", ".4em")
                    .attr("text-anchor", "middle")
                    .text(function (d) {
                        return d.data.percent + "%";
                    })
                    .style({
                        fill: '#000',
                        'font-size': '20px'
                    });

            var legendRectSize = 20;
            var legendSpacing = 7;
            var legendHeight = legendRectSize + legendSpacing;


            var legend = svg.selectAll('.legend')
                    .data(color.domain())
                    .enter()
                    .append('g')
                    .attr({
                        class: 'legend',
                        transform: function (d, i) {
                            //Just a calculation for x & y position
                            return 'translate(-35,' + ((i * legendHeight) - 65) + ')';
                        }
                    });
            legend.append('rect')
                    .attr({
                        width: legendRectSize,
                        height: legendRectSize,
                        rx: 20,
                        ry: 20
                    })
                    .style({
                        fill: color,
                        stroke: color
                    });

            legend.append('text')
                    .attr({
                        x: 30,
                        y: 15
                    })
                    .text(function (d) {
                        return d;
                    }).style({
                fill: '#000',
                'font-size': '14px'
            });
        };

        setTimeout(restOfTheData, 1000);
    }


    function drawBar(data) {

        var margin = {top: 40, right: 20, bottom: 30, left: 200},
                width = 900 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

        var formatPercent = d3.format("$");

        var x = d3.scale.ordinal()
                .rangeRoundBands([0, 200], 0.5);

        var y = d3.scale.linear()
                .domain([0, d3.max(data)])
                .range([height, 0]);

        var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .tickFormat(formatPercent);

        var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function (d) {
                    return "<strong>Utilization:</strong> <span style='color:red'>" + d.value + "</span>";
                });

        var svg = d3.select("#pie")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.call(tip);



        x.domain(data.map(function (d) {
            return d.name;
        }));
        y.domain([0, d3.max(data, function (d) {
            return d.value;
        })]);

        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -140)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Utilization");


        svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", function (d) {
                    return x(d.name);
                })
                .attr("width", x.rangeBand())
                .attr("y", function (d) {
                    return height;
                })
                .attr("height", function (d) {
                    return 0;
                })
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide)
                .transition()
                .duration(400)
                .delay(function (d, i) {
                    return i + 50;
                })
                .attr("y", function (d) {
                    return y(d.value);
                })
                .attr("height", function (d){
                    return y(0) - y(d.value);
                });


        function type(d) {
            d.frequency = +d.value;
            return d;
        }
    }
</script>

<script>


    loadCSVs();

    // **************   PIE	 *****************
    drawPie([]);

    // ************** End of Pie	 *****************


    var treeData = [
        {

            "name": "Rating",
            "parent": "null",
            "children": [
                {
                    "name": "AAA",
                    "parent": "Rating",
                    "children": [{
                        "name": "Emirates",
                        "parent": "AAA",
                        "alloc": 1000000000,
                        "children": [{"name": "Fx OTC Deals", "parent": "Emirates"}, {
                            "name": "Bonds",
                            "parent": "Emirates"
                        }]
                    }, {
                        "name": "Goldman Sachs",
                        "parent": "AAA",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "Goldman Sachs"}]
                    }, {
                        "name": "Reuters",
                        "parent": "AAA",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "Reuters"}]
                    }, {
                        "name": "US Government",
                        "parent": "AAA",
                        "alloc": 1000000000,
                        "children": [{"name": "Bonds", "parent": "US Government"}, {
                            "name": "Equities",
                            "parent": "US Government"
                        }]
                    }]
                }
                , {
                    "name": "AA",
                    "parent": "Rating",
                    "children": [{
                        "name": "Bank of America",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "Fx OTC Deals", "parent": "Bank of America"}, {
                            "name": "Equities",
                            "parent": "Bank of America"
                        }, {"name": "FX Swaps", "parent": "Bank of America"}]
                    }, {
                        "name": "Barclays London",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "L&D Deals", "parent": "Barclays London"}, {
                            "name": "Bonds",
                            "parent": "Barclays London"
                        }]
                    }, {
                        "name": "Government of China",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "Government of China"}]
                    }, {
                        "name": "ING UK",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "FX Swaps", "parent": "ING UK"}]
                    }, {
                        "name": "J.P. Morgan Chase",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "FX Swaps", "parent": "J.P. Morgan Chase"}, {
                            "name": "Equities",
                            "parent": "J.P. Morgan Chase"
                        }]
                    }, {
                        "name": "Reliance",
                        "parent": "AA",
                        "alloc": 1000000000,
                        "children": [{"name": "L&D Deals", "parent": "Reliance"}]
                    }]
                },
                {
                    "name": "A",
                    "parent": "Rating",
                    "children": [{
                        "name": "Citi Bank",
                        "parent": "A",
                        "alloc": 1000000000,
                        "children": [{"name": "IRS Deals", "parent": "Citi Bank"}, {
                            "name": "Bonds",
                            "parent": "Citi Bank"
                        }, {"name": "Equities", "parent": "Citi Bank"}]
                    }, {
                        "name": "Electricite de France",
                        "parent": "A",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "Electricite de France"}]
                    }, {
                        "name": "Government of India",
                        "parent": "A",
                        "alloc": 1000000000,
                        "children": [{"name": "FX Swaps", "parent": "Government of India"}, {
                            "name": "Bonds",
                            "parent": "Government of India"
                        }]
                    }, {
                        "name": "Semex",
                        "parent": "A",
                        "alloc": 1000000000,
                        "children": [{"name": "FX Swaps", "parent": "Semex"}]
                    }]
                }, {
                    "name": "BBB",
                    "parent": "Rating",
                    "children": [{
                        "name": "Capgemini",
                        "parent": "BBB",
                        "alloc": 1000000000,
                        "children": [{"name": "L&D Deals", "parent": "Capgemini"}]
                    }]
                }
                ,
                {
                    "name": "BB",
                    "parent": "Rating",
                    "children": [{
                        "name": "Calimax",
                        "parent": "BB",
                        "alloc": 1000000000,
                        "children": [{"name": "Fx OTC Deals", "parent": "Calimax"}]
                    }, {
                        "name": "General Motors",
                        "parent": "BB",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "General Motors"}, {
                            "name": "Equities",
                            "parent": "General Motors"
                        }]
                    }]
                },
                {
                    "name": "B",
                    "parent": "Rating",
                    "children": [{
                        "name": "Danfoss",
                        "parent": "B",
                        "alloc": 1000000000,
                        "children": [{"name": "IRS Deals", "parent": "Danfoss"}]
                    }, {
                        "name": "Fairchild Group",
                        "parent": "B",
                        "alloc": 1000000000,
                        "children": [{"name": "IRS Deals", "parent": "Fairchild Group"}, {
                            "name": "Equities",
                            "parent": "Fairchild Group"
                        }]
                    }]
                }, {
                    "name": "CCC",
                    "parent": "Rating",
                    "children": [{
                        "name": "Copacol",
                        "parent": "CCC",
                        "alloc": 1000000000,
                        "children": [{"name": "Equities", "parent": "Copacol"}]
                    }, {
                        "name": "Vita",
                        "parent": "CCC",
                        "alloc": 1000000000,
                        "children": [{"name": "Fx OTC Deals", "parent": "Vita"}]
                    }]
                },
                {
                    "name": "C",
                    "parent": "Rating",
                    "children": [{
                        "name": "Aerol�neas Argentinas",
                        "parent": "C",
                        "alloc": 1000000000,
                        "children": [{"name": "L&D Deals", "parent": "Aerol�neas Argentinas"}, {
                            "name": "Equities",
                            "parent": "Aerol�neas Argentinas"
                        }]
                    }, {
                        "name": "Virgin Trains",
                        "parent": "C",
                        "alloc": 1000000000,
                        "children": [{"name": "IRS Deals", "parent": "Virgin Trains"}]
                    }]
                }, {
                    "name": "D",
                    "parent": "Rating",
                    "children": [{
                        "name": "Magix",
                        "parent": "D",
                        "alloc": 1000000000,
                        "children": [{"name": "L&D Deals", "parent": "Magix"}]
                    }]
                }
            ]
        }
    ];


    // ************** Generate the tree diagram	 *****************
    var margin = {top: 20, right: 120, bottom: 20, left: 120},
            width = 1000 - margin.right - margin.left,
            height = 1000 - margin.top - margin.bottom;

    var i = 0,
            duration = 750,
            root;

    var tree = d3.layout.tree()
            .size([height, width]);

    var diagonal = d3.svg.diagonal()
            .projection(function (d) {
                return [d.y, d.x];
            });

    var svg = d3.select("#tree").append("svg")
            .attr("width", width)
            .attr("height", 2000)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    root = treeData[0];
    root.x0 = height / 2;
    root.y0 = 0;

    update(root);
    collapseAll();

    d3.select(self.frameElement).style("height", "500px");

    function update(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
                links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function (d) {
            d.y = d.depth * 180;
        });

        // Update the nodes…
        var node = svg.selectAll("g.node")
                .data(nodes, function (d) {
                    return d.id || (d.id = ++i);
                });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + source.y0 + "," + source.x0 + ")";
                })
                .on("click", click);

        nodeEnter.append("circle")
                .attr("r", 1e-6)
                .style("fill", function (d) {
                    return d._children ? "lightsteelblue" : "#fff";
                });

        nodeEnter.append("text")
                .attr("x", function (d) {
                    return d.children || d._children ? -13 : 13;
                })
                .attr("dy", ".35em")
                .attr("text-anchor", function (d) {
                    return d.children || d._children ? "end" : "start";
                })
                .text(function (d) {
                    return d.name;
                })
                .style("fill-opacity", 1e-6);

        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
                .duration(duration)
                .attr("transform", function (d) {
                    return "translate(" + d.y + "," + d.x + ")";
                });

        nodeUpdate.select("circle")
                .attr("r", 10)
                .style("fill", function (d) {
                    return d._children ? "lightsteelblue" : "#fff";
                });

        nodeUpdate.select("text")
                .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", function (d) {
                    return "translate(" + source.y + "," + source.x + ")";
                })
                .remove();

        nodeExit.select("circle")
                .attr("r", 1e-6);

        nodeExit.select("text")
                .style("fill-opacity", 1e-6);

        // Update the links…
        var link = svg.selectAll("path.link")
                .data(links, function (d) {
                    return d.target.id;
                });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", function (d) {
                    var o = {x: source.x0, y: source.y0};
                    return diagonal({source: o, target: o});
                });

        // Transition links to their new position.
        link.transition()
                .duration(duration)
                .attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
                .duration(duration)
                .attr("d", function (d) {
                    var o = {x: source.x, y: source.y};
                    return diagonal({source: o, target: o});
                })
                .remove();

        // Stash the old positions for transition.
        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {


        if (d.depth == 3) {
            d3.select("#pie svg").remove();

            var value;
            var alloc = d.parent.alloc;

            switch (d.name) {
                case "IRS Deals":
                    value = IRSDealMap[d.parent.name].value;
                    break;
                case "Bonds":
                    value = BondMap[d.parent.name].value;
                    break;
                case "Equities":
                    value = EquititesMap[d.parent.name].value;
                    break;
                case "FX Swaps":
                    value = FxSwapMap[d.parent.name].value;
                    break;

                case "Fx OTC Deals":
                    value = FxOTCMap[d.parent.name].value;
                    break;
                case "L&D Deals":
                    value = LDDealMap[d.parent.name].value;
                    break;
            }

            var dataset;

            if ((value / alloc * 100).toFixed(2) > 100) {
                dataset = [{name: "Utilized", percent: (value / alloc * 100).toFixed(2)}];

            }
            else if ((value / alloc * 100).toFixed(2) < 0) {
                dataset = [{name: "Utilized", percent: (value / alloc * 100).toFixed(2) * -1}, {
                    name: "Not Utilized",
                    percent: (100 - value / alloc * 100 * -1).toFixed(2)
                }];
            }
            else {
                dataset = [{name: "Utilized", percent: (value / alloc * 100).toFixed(2)}, {
                    name: "Not Utilized",
                    percent: (100 - value / alloc * 100).toFixed(2)
                }];
            }

            debugger;

            if(value < 0) value *=-1;

            document.getElementById("header").innerHTML = "<span>" + d.parent.name + "</span><br/><span>" + d.name + "</span><br/><span> Utilization - $"+ value;
            drawPie(dataset);
        }

        else if (d.depth == 2) {
            d3.select("#pie svg").remove();


            var Counterparty = map[d.name];

            let Avlength = Counterparty["product-exp"].length;

            var totalExpValue = [];

            for (let exp in Counterparty["product-exp"]) {
                let Expvalue;
                switch (Counterparty["product-exp"][exp]) {
                    case "PE_IRS":
                    case "PE_IRS1":
                        Expvalue = { name: "IRS Deals", value: IRSDealMap[d.name].value<0?IRSDealMap[d.name].value * -1:IRSDealMap[d.name].value  };
                        break;
                    case "PE_BND":
                    case "PE_BND1":
                        Expvalue = { name: "Bonds", value: BondMap[d.name].value<0?BondMap[d.name].value * -1:BondMap[d.name].value   };
                        break;
                    case "PE_EQU":
                    case "PE_EQU1":
                        Expvalue = { name: "Equities", value: EquititesMap[d.name].value<0?EquititesMap[d.name].value * -1:EquititesMap[d.name].value   };
                        break;
                    case "PE_FXS":
                    case "PE_FXS1":
                        Expvalue = { name: "Fx Swap Deals", value: FxSwapMap[d.name].value<0?FxSwapMap[d.name].value * -1:FxSwapMap[d.name].value };
                        break;

                    case "PE_FXO":
                    case "PE_FXO1":
                        Expvalue = { name: "FxOTC Deals", value: FxOTCMap[d.name].value<0?FxOTCMap[d.name].value * -1:FxOTCMap[d.name].value };
                        break;
                    case "PE_LD":
                    case "PE_LD1":
                        Expvalue = { name: "L&D Deals", value: LDDealMap[d.name].value<0?LDDealMap[d.name].value * -1:LDDealMap[d.name].value  };
                        break;
                }

                totalExpValue.push(Expvalue);
                debugger;
            }

            debugger;
            drawBar(totalExpValue);


        }
        else
        {
            d3.select("#pie svg").remove();
            document.getElementById("header").innerHTML = "";
        }


        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }

        d.highlight = true;
        update(d);
    }


    function expand(d) {
        var children = (d.children) ? d.children : d._children;
        if (d._children) {
            d.children = d._children;
            d._children = null;
        }
        if (children)
            children.forEach(expand);
    }

    function expandAll() {
        expand(root);
        update(root);
    }

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }
    function collapseAll() {

        d3.select("#pie svg").remove();
        document.getElementById("header").innerHTML = "";



        root.children.forEach(collapse);
        collapse(root);
        update(root);
    }

</script>

</body>
</html>
